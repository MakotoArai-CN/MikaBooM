name: Cross-Platform Build with CGO

on:
  push:
    branches: [ main, dev ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GO_VERSION: '1.21'
  APP_NAME: 'MikaBooM'

jobs:
  # ============ Linux å¹³å°ç¼–è¯‘ ============
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
      matrix:
        include:
          # Linux AMD64
          - arch: amd64
            cc: gcc
            cxx: g++
            
          # Linux ARM64
          - arch: arm64
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
            pkg_config_path: /usr/lib/aarch64-linux-gnu/pkgconfig
            dpkg_arch: arm64
            packages: gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libgtk-3-dev:arm64 libappindicator3-dev:arm64
            
          # Linux ARM32 v7
          - arch: arm
            cc: arm-linux-gnueabihf-gcc
            cxx: arm-linux-gnueabihf-g++
            goarm: "7"
            pkg_config_path: /usr/lib/arm-linux-gnueabihf/pkgconfig
            dpkg_arch: armhf
            packages: gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf libgtk-3-dev:armhf libappindicator3-dev:armhf
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽç‰ˆæœ¬å·
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Install Dependencies (AMD64)
        if: matrix.arch == 'amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libappindicator3-dev \
            pkg-config \
            build-essential
      
      - name: Install Cross-Compile Dependencies
        if: matrix.arch != 'amd64'
        run: |
          sudo dpkg --add-architecture ${{ matrix.dpkg_arch }}
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      
      - name: Build
        env:
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 1
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
          PKG_CONFIG_PATH: ${{ matrix.pkg_config_path }}
        run: |
          # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION=${GITHUB_REF_NAME#v}
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="dev-$(git describe --always --dirty)"
          fi
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          # è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆ2å¹´åŽï¼‰
          EXPIRE_DATE=$(date -u -d "+2 years" +"%Y-%m-%d %H:%M:%S")
          
          # æž„å»º LDFLAGS
          LDFLAGS="-s -w"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.Version=${VERSION}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.BuildDate=${BUILD_DATE}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.CommitHash=${COMMIT_HASH}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.ExpireDate=${EXPIRE_DATE}'"
          
          # ç¼–è¯‘
          mkdir -p dist/linux
          OUTPUT_NAME="${APP_NAME}-linux-${{ matrix.arch }}"
          if [ "${{ matrix.goarm }}" != "" ]; then
            OUTPUT_NAME="${OUTPUT_NAME}v${{ matrix.goarm }}"
          fi
          
          go build -v -ldflags="$LDFLAGS" -o "dist/linux/${OUTPUT_NAME}"
          
          # ç”Ÿæˆæž„å»ºä¿¡æ¯
          echo "Version: ${VERSION}" > "dist/linux/${OUTPUT_NAME}.info"
          echo "Build Date: ${BUILD_DATE}" >> "dist/linux/${OUTPUT_NAME}.info"
          echo "Commit: ${COMMIT_HASH}" >> "dist/linux/${OUTPUT_NAME}.info"
          echo "Platform: linux/${{ matrix.arch }}" >> "dist/linux/${OUTPUT_NAME}.info"
          
          # æ–‡ä»¶ä¿¡æ¯
          ls -lh "dist/linux/${OUTPUT_NAME}"
          file "dist/linux/${OUTPUT_NAME}"
      
      - name: Test Binary
        if: matrix.arch == 'amd64'  # åªåœ¨æœ¬åœ°æž¶æž„æµ‹è¯•
        run: |
          chmod +x dist/linux/${APP_NAME}-linux-${{ matrix.arch }}
          dist/linux/${APP_NAME}-linux-${{ matrix.arch }} --version || echo "Version flag not implemented"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}${{ matrix.goarm && format('v{0}', matrix.goarm) || '' }}
          path: |
            dist/linux/*
          retention-days: 7

  # ============ Windows å¹³å°ç¼–è¯‘ ============
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows AMD64
          - arch: amd64
            cc: x86_64-w64-mingw32-gcc
            cxx: x86_64-w64-mingw32-g++
            
          # Windows 386
          - arch: "386"
            cc: i686-w64-mingw32-gcc
            cxx: i686-w64-mingw32-g++
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Install MinGW
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64 g++-mingw-w64
      
      - name: Build
        env:
          GOOS: windows
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 1
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="dev-$(git describe --always --dirty)"
          fi
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          EXPIRE_DATE=$(date -u -d "+2 years" +"%Y-%m-%d %H:%M:%S")
          
          LDFLAGS="-s -w -H=windowsgui"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.Version=${VERSION}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.BuildDate=${BUILD_DATE}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.CommitHash=${COMMIT_HASH}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.ExpireDate=${EXPIRE_DATE}'"
          
          mkdir -p dist/windows
          OUTPUT_NAME="${APP_NAME}-windows-${{ matrix.arch }}.exe"
          
          go build -v -ldflags="$LDFLAGS" -o "dist/windows/${OUTPUT_NAME}"
          
          echo "Version: ${VERSION}" > "dist/windows/${OUTPUT_NAME}.info"
          echo "Build Date: ${BUILD_DATE}" >> "dist/windows/${OUTPUT_NAME}.info"
          echo "Commit: ${COMMIT_HASH}" >> "dist/windows/${OUTPUT_NAME}.info"
          echo "Platform: windows/${{ matrix.arch }}" >> "dist/windows/${OUTPUT_NAME}.info"
          
          ls -lh "dist/windows/${OUTPUT_NAME}"
          file "dist/windows/${OUTPUT_NAME}"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: |
            dist/windows/*
          retention-days: 7

  # ============ macOS å¹³å°ç¼–è¯‘ ============
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-13  # Intel Mac
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS AMD64 (Intel)
          - arch: amd64
            
          # macOS ARM64 (Apple Silicon)
          - arch: arm64
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Build
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 1
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="dev-$(git describe --always --dirty)"
          fi
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          # macOS è®¡ç®—è¿‡æœŸæ—¶é—´
          EXPIRE_DATE=$(date -u -v+2y +"%Y-%m-%d %H:%M:%S")
          
          LDFLAGS="-s -w"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.Version=${VERSION}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.BuildDate=${BUILD_DATE}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.CommitHash=${COMMIT_HASH}'"
          LDFLAGS="$LDFLAGS -X 'MikaBooM/internal/version.ExpireDate=${EXPIRE_DATE}'"
          
          mkdir -p dist/darwin
          OUTPUT_NAME="${APP_NAME}-darwin-${{ matrix.arch }}"
          
          go build -v -ldflags="$LDFLAGS" -o "dist/darwin/${OUTPUT_NAME}"
          
          echo "Version: ${VERSION}" > "dist/darwin/${OUTPUT_NAME}.info"
          echo "Build Date: ${BUILD_DATE}" >> "dist/darwin/${OUTPUT_NAME}.info"
          echo "Commit: ${COMMIT_HASH}" >> "dist/darwin/${OUTPUT_NAME}.info"
          echo "Platform: darwin/${{ matrix.arch }}" >> "dist/darwin/${OUTPUT_NAME}.info"
          
          ls -lh "dist/darwin/${OUTPUT_NAME}"
          file "dist/darwin/${OUTPUT_NAME}"
      
      - name: Test Binary
        if: matrix.arch == 'amd64'
        run: |
          chmod +x dist/darwin/${APP_NAME}-darwin-${{ matrix.arch }}
          dist/darwin/${APP_NAME}-darwin-${{ matrix.arch }} --version || echo "Version flag not implemented"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: darwin-${{ matrix.arch }}
          path: |
            dist/darwin/*
          retention-days: 7

  # ============ åˆ›å»ºå‘å¸ƒåŒ… ============
  package:
    name: Package Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Display Structure
        run: |
          ls -R artifacts/
      
      - name: Create Release Archives
        run: |
          mkdir -p release
          cd artifacts
          
          # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºåŽ‹ç¼©åŒ…
          for platform_dir in */; do
            platform=${platform_dir%/}
            echo "æ‰“åŒ… ${platform}..."
            
            cd "${platform}"
            
            # åˆ›å»º tar.gz
            tar -czf "../../release/${APP_NAME}-${platform}.tar.gz" *
            
            # åˆ›å»º zip (Windowså‹å¥½)
            zip -r "../../release/${APP_NAME}-${platform}.zip" *
            
            cd ..
          done
          
          cd ../release
          ls -lh
      
      - name: Generate SHA256 Checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt
      
      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: release/*
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸŽ‰ MikaBooM ${{ github.ref_name }}
            
            ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
            
            #### Linux
            - `MikaBooM-linux-amd64` - 64ä½ x86 (æŽ¨è)
            - `MikaBooM-linux-arm64` - ARM64 (æ ‘èŽ“æ´¾4/5, æœåŠ¡å™¨)
            - `MikaBooM-linux-armv7` - ARM32 v7 (æ ‘èŽ“æ´¾2/3)
            
            #### Windows
            - `MikaBooM-windows-amd64.exe` - 64ä½ (æŽ¨è)
            - `MikaBooM-windows-386.exe` - 32ä½
            
            #### macOS
            - `MikaBooM-darwin-amd64` - Intel Mac
            - `MikaBooM-darwin-arm64` - Apple Silicon (M1/M2/M3)
            
            ### âœ… æ‰€æœ‰ç‰ˆæœ¬å‡æ”¯æŒç³»ç»Ÿæ‰˜ç›˜ (CGOç¼–è¯‘)
            
            ### ðŸ” æ ¡éªŒå’Œ
            ä¸‹è½½åŽè¯·éªŒè¯ SHA256 æ ¡éªŒå’Œï¼š
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: ${{ github.event.repository.html_url }}/compare/${{ github.event.before }}...${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============ ç¼–è¯‘ç»Ÿè®¡ ============
  summary:
    name: Build Summary
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-22.04
    if: always()
    
    steps:
      - name: Check Build Results
        run: |
          echo "## ðŸ“Š æž„å»ºç»“æžœæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux AMD64 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux ARM64 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux ARMv7 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows AMD64 | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows 386 | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS AMD64 | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-linux.result }}" = "success" ] && \
             [ "${{ needs.build-windows.result }}" = "success" ] && \
             [ "${{ needs.build-macos.result }}" = "success" ]; then
            echo "âœ… **æ‰€æœ‰å¹³å°ç¼–è¯‘æˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **éƒ¨åˆ†å¹³å°ç¼–è¯‘å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi